apiVersion: v1
kind: Namespace
metadata:
    name: payment
---
apiVersion: v1
kind: ServiceAccount
metadata:
    name: payment
    namespace: payment
---
apiVersion: v1
kind: Service
metadata:
    name: payment-service
    namespace: payment
spec:
    selector:
        app: payment
    ports:
        - protocol: TCP
          port: 80
          targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: payment
    namespace: payment
spec:
    selector:
        matchLabels:
            app: payment
    template:
        metadata:
            labels:
                app: payment
        spec:
            serviceAccountName: payment
            containers:
                - name: payment
                  image: soatproject/fastfood-soat-payment-service:latest
                  ports:
                      - containerPort: 8080
                  envFrom:
                    - configMapRef:
                      name: payment-configmap
                    - secretRef:
                      name: payment-secret
                  resources:
                      requests:
                          cpu: "500m"
                          memory: "512Mi"
                      limits:
                          cpu: "1"
                          memory: "2Gi"
                  livenessProbe:
                          httpGet:
                              path: /health
                              port: 8080
                          initialDelaySeconds: 30
                          periodSeconds: 10
                          failureThreshold: 3
                  readinessProbe:
                          httpGet:
                              path: /health
                              port: 8080
                          initialDelaySeconds: 30
                          periodSeconds: 5
                          failureThreshold: 3
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: payment
    namespace: payment
spec:
    parentRefs:
        - name: eg
          namespace: envoy-gateway-system
    rules:
        - backendRefs:
              - group: ""
                kind: Service
                name: payment-service
                namespace: payment
                port: 80
                weight: 1
          matches:
              - path:
                    type: PathPrefix
                    value: /payment
---
apiVersion: v1
kind: ConfigMap
metadata:
    name: payment-configmap
    namespace: payment
data:
    APPLICATION_PORT: "8080"
    MERCADO_PAGO_BASE_URL: "https://api.mercadopago.com"
    AWS_REGION: "sa-east-1"
    
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
    name: payment-hpa
    namespace: payment
spec:
    scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: payment
    minReplicas: 3
    maxReplicas: 10
    metrics:
        - type: Resource
          resource:
              name: cpu
              target:
                  type: Utilization
                  averageUtilization: 50
        - type: Resource
          resource:
              name: memory
              target:
                  type: Utilization
                  averageUtilization: 70
